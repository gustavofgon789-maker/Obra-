<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes | ùîíbra√≠</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --deep-bg: #0a0f0d; --card-bg: #141a17; --primary: #10b981; --text-main: #e2e8f0; --text-muted: #94a3b8; --border: #1e2923; }
    body { font-family: 'Inter', sans-serif; background: var(--deep-bg); color: var(--text-main); margin: 0; padding-bottom: 100px; }
    
    .btn-voltar { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; z-index: 10; cursor: pointer; }
    .topo-img { width: 100%; height: 350px; object-fit: cover; }
    
    .conteudo { padding: 25px; margin-top: -30px; background: var(--deep-bg); border-radius: 30px 30px 0 0; position: relative; }
    .preco-tag { background: var(--primary); color: var(--deep-bg); padding: 6px 15px; border-radius: 100px; font-weight: 800; font-size: 14px; display: inline-block; margin-bottom: 15px; }
    h1 { font-size: 26px; margin: 0 0 10px; font-weight: 800; }
    .local-info { color: var(--text-muted); font-size: 14px; margin-bottom: 25px; }

    .sessao-reserva { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 24px; margin-top: 20px; }
    .label-reserva { display: block; font-weight: 700; margin-bottom: 10px; font-size: 14px; }
    
    #inputCalendario { width: 100%; padding: 15px; background: #0a0f0d; border: 1px solid var(--border); border-radius: 12px; color: white; text-align: center; font-size: 16px; margin-bottom: 15px; }

    .btn-alugar { width: 100%; padding: 18px; background: var(--primary); color: var(--deep-bg); border: none; border-radius: 18px; font-weight: 800; font-size: 16px; cursor: pointer; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2); }
    
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--deep-bg); display:flex; align-items:center; justify-content:center; z-index:100; color:var(--primary); font-weight:700; }
  </style>
</head>
<body>

<div id="loader">Sincronizando ferramenta...</div>

<button class="btn-voltar" onclick="history.back()">‚Üê</button>
<img id="detalheImg" src="" class="topo-img">

<div class="conteudo">
  <div class="preco-tag" id="detalhePreco">R$ --</div>
  <h1 id="detalheNome">---</h1>
  <div class="local-info">üìç <span id="detalheLocal">---</span></div>
  <p id="detalheDesc" style="line-height:1.6; color:var(--text-muted)"></p>

  <div class="sessao-reserva">
    <span class="label-reserva">Selecione os dias:</span>
    <input type="text" id="inputCalendario" placeholder="Toque para escolher as datas" readonly>
    
    <div id="resumoValores" style="display:none; margin-bottom:20px; border-top:1px solid var(--border); padding-top:15px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px">
            <span style="color:var(--text-muted)">Total de dias:</span>
            <span id="totalDias">0</span>
        </div>
        <div style="display:flex; justify-content:space-between; font-weight:800; font-size:18px">
            <span>Valor Total:</span>
            <span id="valorFinal" style="color:var(--primary)">R$ 0,00</span>
        </div>
    </div>

    <button class="btn-alugar" id="btnWhatsapp">Chamar no WhatsApp</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBLvvoNS4VF2Y0rOh-dHj3GFiwao1D4KYU",
    authDomain: "obrai-56278.firebaseapp.com",
    projectId: "obrai-56278",
    storageBucket: "obrai-56278.firebasestorage.app",
    messagingSenderId: "735990959965",
    appId: "1:735990959965:web:d28f6cbc7b85abfd48e2b4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');

  if (!id) window.location.href = "index.html";

  async function carregarTudo() {
    try {
      // 1. Carregar Dados da Ferramenta
      const docRef = doc(db, "anuncios", id);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) return window.location.href = "index.html";
      const ferramenta = docSnap.data();

      document.getElementById("detalheImg").src = ferramenta.imagem;
      document.getElementById("detalheNome").innerText = ferramenta.nome;
      document.getElementById("detalhePreco").innerText = `R$ ${ferramenta.preco} / dia`;
      document.getElementById("detalheLocal").innerText = ferramenta.cidade || "Regi√£o";
      document.getElementById("detalheDesc").innerText = ferramenta.descricao || "";

      // 2. Buscar Reservas para Bloqueio
      const qReservas = query(collection(db, "reservas"), where("id_ferramenta", "==", id));
      const snapReservas = await getDocs(qReservas);
      let datasDesativadas = [];

      snapReservas.forEach(res => {
        const d = res.data();
        // Corre√ß√£o de fuso hor√°rio para garantir que a data no calend√°rio seja a correta
        datasDesativadas.push({ 
          from: new Date(d.inicio + "T00:00:00"), 
          to: new Date(d.fim + "T00:00:00") 
        });
      });

      // 3. Inicializar Calend√°rio (Apenas UMA vez)
      flatpickr("#inputCalendario", {
        mode: "range",
        minDate: "today",
        dateFormat: "d/m/Y",
        disable: datasDesativadas,
        theme: "dark",
        locale: "pt",
        onChange: (selectedDates) => {
          if (selectedDates.length === 2) {
            const diff = Math.ceil((selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24)) + 1;
            
            // Limpa o pre√ßo para c√°lculo num√©rico
            const precoLimpo = parseFloat(ferramenta.preco.toString().replace('R$', '').replace('.', '').replace(',', '.').trim());
            const total = diff * precoLimpo;
            
            document.getElementById("resumoValores").style.display = "block";
            document.getElementById("totalDias").innerText = diff;
            document.getElementById("valorFinal").innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            document.getElementById("btnWhatsapp").onclick = () => {
                const msg = `Ol√°! Quero alugar a ${ferramenta.nome} de ${selectedDates[0].toLocaleDateString('pt-BR')} at√© ${selectedDates[1].toLocaleDateString('pt-BR')} (${diff} dias).`;
                window.open(`https://wa.me/${ferramenta.telefone}?text=${encodeURIComponent(msg)}`);
            };
          }
        }
      });

      document.getElementById("loader").style.display = "none";
    } catch (e) { 
      console.error("Erro ao carregar detalhes:", e);
      document.getElementById("loader").innerText = "Erro ao carregar ferramenta.";
    }
  }

  carregarTudo();
</script>
</body>
</html>
