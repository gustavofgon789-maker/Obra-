<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Profissional | ùîíbra√≠</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --deep-bg: #050706; --card-bg: #0f1412; --primary: #10b981;
      --primary-soft: rgba(16, 185, 129, 0.1); --danger: #ef4444;
      --warning: #f59e0b;
      --text-main: #f8fafc; --text-muted: #64748b; --border: #1e2923;
      --gold: #f59e0b;
    }
    body { font-family: 'Inter', sans-serif; background: var(--deep-bg); margin: 0; color: var(--text-main); padding-bottom: 110px; }
    
    /* Header Business */
    .profile-header { text-align: center; padding: 50px 20px 30px; background: radial-gradient(circle at top, #10b98115 0%, transparent 70%); }
    .profile-img-container { position: relative; width: 110px; margin: 0 auto; }
    .profile-img { width: 100px; height: 100px; border-radius: 30px; border: 2px solid var(--primary); padding: 3px; object-fit: cover; background: var(--card-bg); }
    .verified-badge { position: absolute; bottom: 5px; right: 5px; background: var(--primary); color: #000; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 3px solid var(--deep-bg); font-weight: bold; }

    /* Dashboard */
    .business-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 20px 20px; }
    .stat-box { background: var(--card-bg); padding: 20px; border-radius: 24px; border: 1px solid var(--border); }
    .stat-box.full { grid-column: span 2; background: linear-gradient(135deg, var(--card-bg) 0%, #10b9810a 100%); }
    .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px; display: block; }
    .stat-value { font-size: 24px; font-weight: 800; color: var(--text-main); }
    .stat-value.money { color: var(--primary); }

    .section-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
    .section-header h3 { font-size: 18px; margin: 0; font-weight: 800; }

    /* Lista Profissional com Status */
    .meus-anuncios { padding: 0 20px; }
    .item-anuncio { background: var(--card-bg); border-radius: 24px; padding: 16px; display: flex; align-items: center; margin-bottom: 15px; border: 1px solid var(--border); position: relative; overflow: hidden; }
    .item-img { width: 70px; height: 70px; border-radius: 16px; object-fit: cover; margin-right: 15px; }
    .item-info { flex-grow: 1; }
    .item-nome { font-weight: 700; font-size: 15px; margin: 0 0 6px; }
    
    /* Tags de Status */
    .status-badge { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 8px; display: inline-flex; align-items: center; gap: 5px; }
    .status-disponivel { background: var(--primary-soft); color: var(--primary); }
    .status-alugado { background: rgba(245, 158, 11, 0.1); color: var(--warning); }

    .acoes-anuncio { display: flex; gap: 8px; }
    .btn-circle { width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); background: #161b19; cursor: pointer; text-decoration: none; font-size: 16px; }

    /* Modal */
    #modalReserva { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    .modal-content { background: var(--card-bg); width: 85%; max-width: 360px; padding: 30px; border-radius: 32px; border: 1px solid var(--border); text-align: center; }
    .btn-main { background: var(--primary); color: #000; border: none; width: 100%; padding: 16px; border-radius: 16px; font-weight: 800; margin-top: 20px; cursor: pointer; }
    
    .btn-sair { display: block; margin: 20px; padding: 18px; text-align: center; color: var(--danger); border: 1px solid rgba(239,68,68,0.2); border-radius: 20px; text-decoration: none; font-weight: 700; font-size: 14px; }
    
    .app-footer { position: fixed; bottom: 0; width: 100%; background: rgba(5,7,6,0.9); backdrop-filter: blur(20px); height: 85px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 100; }
    .footer-item { text-decoration: none; color: var(--text-muted); font-size: 10px; text-align: center; font-weight: 600; }
  </style>
</head>
<body>

<div class="profile-header">
    <div class="profile-img-container">
        <img id="userPhoto" src="" class="profile-img" onerror="this.src='https://via.placeholder.com/100?text=üë§'">
        <div class="verified-badge">‚úì</div>
    </div>
    <h2 id="userName" style="margin:15px 0 5px; font-size: 22px; font-weight: 800;">Painel de Neg√≥cios</h2>
    <p id="userEmail" style="color:var(--text-muted); font-size:13px; margin:0;"></p>
</div>

<div class="business-stats">
    <div class="stat-box full">
        <span class="stat-label">üí∞ Receita Mensal Estimada</span>
        <span class="stat-value money" id="ganhoValor">R$ 0,00</span>
    </div>
    <div class="stat-box">
        <span class="stat-label">üõ†Ô∏è Ativos</span>
        <span class="stat-value" id="countAnuncios">0</span>
    </div>
    <div class="stat-box">
        <span class="stat-label">‚≠ê Performance</span>
        <span class="stat-value" style="color: var(--gold);">5.0</span>
    </div>
</div>

<div class="section-header">
    <h3>Gest√£o de Ativos</h3>
    <button onclick="window.location.href='anunciar.html'" style="background:var(--primary-soft); border:none; color:var(--primary); padding:8px 15px; border-radius:12px; font-weight:700; font-size:12px; cursor:pointer">+ Ativo</button>
</div>

<div id="listaMeusAnuncios" class="meus-anuncios"></div>

<a href="#" id="btnSair" class="btn-sair">Desconectar Sistema</a>

<div id="modalReserva">
  <div class="modal-content">
    <h3>Agenda do Ativo</h3>
    <input type="text" id="calendarioBloqueio" style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border); background:#000; color:#fff; text-align:center; font-weight:700; margin-bottom:10px">
    <button class="btn-main" id="btnSalvarBloqueio">Bloquear Datas</button>
    <button id="btnLimpar" style="background:none; border:none; color:var(--danger); font-weight:700; margin-top:20px; width:100%; cursor:pointer">Limpar Agenda</button>
    <button onclick="fecharModal()" style="background:none; border:none; color:var(--text-muted); margin-top:20px; cursor:pointer">Voltar</button>
  </div>
</div>

<nav class="app-footer">
  <a href="index.html" class="footer-item">üè†<br>In√≠cio</a>
  <a href="anunciar.html" style="background:var(--primary); color:#000; width:50px; height:50px; border-radius:18px; display:flex; align-items:center; justify-content:center; text-decoration:none; font-size:26px; font-weight:bold; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">+</a>
  <a href="perfil.html" class="footer-item" style="color:var(--primary)">üë§<br>Painel</a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, deleteDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBLvvoNS4VF2Y0rOh-dHj3GFiwao1D4KYU",
    authDomain: "obrai-56278.firebaseapp.com",
    projectId: "obrai-56278",
    storageBucket: "obrai-56278.firebasestorage.app",
    messagingSenderId: "735990959965",
    appId: "1:735990959965:web:d28f6cbc7b85abfd48e2b4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let idSelecionado = null;
  let datasSelecionadas = [];

  const fp = flatpickr("#calendarioBloqueio", {
    mode: "range",
    minDate: "today",
    dateFormat: "Y-m-d",
    theme: "dark",
    onChange: (dates) => { datasSelecionadas = dates; }
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById("userName").innerText = user.displayName || 'Parceiro Obra√≠';
      document.getElementById("userPhoto").src = user.photoURL || '';
      document.getElementById("userEmail").innerText = user.email;
      carregarDashboard(user.uid);
    } else { window.location.href = "login.html"; }
  });

  async function carregarDashboard(userId) {
    const lista = document.getElementById("listaMeusAnuncios");
    const qAnuncios = query(collection(db, "anuncios"), where("userId", "==", userId));
    const snapAnuncios = await getDocs(qAnuncios);
    
    // Buscar TODAS as reservas de uma vez para comparar
    const snapReservas = await getDocs(collection(db, "reservas"));
    const reservasAtivas = snapReservas.docs.map(d => d.data());

    lista.innerHTML = "";
    let estimativaTotal = 0;
    const hoje = new Date().toISOString().split('T')[0];

    snapAnuncios.forEach((docSnap) => {
      const item = docSnap.data();
      const idFerramenta = docSnap.id;
      
      // C√°lculo de Ganhos
      const preco = parseFloat(item.preco.toString().replace('R$', '').replace(',', '.').trim()) || 0;
      estimativaTotal += (preco * 4);

      // L√≥gica de Status em Tempo Real
      const estaReservada = reservasAtivas.some(res => 
        res.id_ferramenta === idFerramenta && 
        hoje >= res.inicio && hoje <= res.fim
      );

      const statusHtml = estaReservada 
        ? `<span class="status-badge status-alugado">‚óè Em Uso</span>`
        : `<span class="status-badge status-disponivel">‚óè Dispon√≠vel</span>`;

      const div = document.createElement("div");
      div.className = "item-anuncio";
      div.innerHTML = `
        <img src="${item.imagem}" class="item-img">
        <div class="item-info">
          <p class="item-nome">${item.nome}</p>
          ${statusHtml}
        </div>
        <div class="acoes-anuncio">
          <button class="btn-circle" onclick="abrirModal('${idFerramenta}')">üìÖ</button>
          <a href="editar.html?id=${idFerramenta}" class="btn-circle" style="color:var(--primary)">‚úèÔ∏è</a>
          <button class="btn-circle" style="color:var(--danger)" onclick="removerAnuncio('${idFerramenta}')">üóëÔ∏è</button>
        </div>
      `;
      lista.appendChild(div);
    });

    document.getElementById("countAnuncios").innerText = snapAnuncios.size;
    document.getElementById("ganhoValor").innerText = `R$ ${estimativaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
  }

  window.abrirModal = (id) => {
    idSelecionado = id;
    document.getElementById("modalReserva").style.display = "flex";
  };

  window.fecharModal = () => {
    document.getElementById("modalReserva").style.display = "none";
    fp.clear();
  };

  document.getElementById("btnSalvarBloqueio").onclick = async () => {
    if (datasSelecionadas.length < 2) return alert("Selecione o per√≠odo.");
    try {
      await addDoc(collection(db, "reservas"), {
        id_ferramenta: idSelecionado,
        inicio: datasSelecionadas[0].toISOString().split('T')[0],
        fim: datasSelecionadas[1].toISOString().split('T')[0]
      });
      alert("Agenda atualizada!");
      location.reload();
    } catch (e) { alert("Erro ao salvar."); }
  };

  document.getElementById("btnLimpar").onclick = async () => {
    if (!idSelecionado) return;
    if (confirm("Limpar toda a agenda deste ativo?")) {
      const q = query(collection(db, "reservas"), where("id_ferramenta", "==", idSelecionado));
      const snap = await getDocs(q);
      const promises = snap.docs.map(d => deleteDoc(doc(db, "reservas", d.id)));
      await Promise.all(promises);
      alert("Agenda liberada!");
      location.reload();
    }
  };

  window.removerAnuncio = async (id) => {
    if (confirm("Remover este ativo permanentemente?")) {
      await deleteDoc(doc(db, "anuncios", id));
      location.reload();
    }
  };

  document.getElementById("btnSair").onclick = () => signOut(auth).then(() => window.location.href="index.html");
</script>
</body>
</html>
