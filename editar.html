<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Ferramenta | Obrahhí</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --deep-bg: #0a0f0d;
      --card-bg: #141a17;
      --primary: #10b981;
      --text-main: #e2e8f0;
      --text-muted: #94a3b8;
      --border: #1e2923;
    }
    
    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--deep-bg); 
      margin: 0; 
      color: var(--text-main); 
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .container { 
      width: 100%;
      max-width: 480px; 
      padding: 30px 20px; 
      box-sizing: border-box;
    }

    .header { text-align: center; margin-bottom: 25px; }
    h2 { color: var(--primary); font-weight: 800; font-size: 24px; margin: 0; letter-spacing: -1px; }

    /* Preview da Imagem Corrigido */
    .preview-container {
      width: 100%;
      height: 220px;
      background: #000; /* Fundo preto para imagens com transparência */
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid var(--border);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #imgPreview { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      display: block; /* Remove espaços vazios abaixo da imagem */
    }

    .form-group { margin-bottom: 18px; width: 100%; box-sizing: border-box; }

    label { 
      display: block; 
      font-weight: 700; 
      margin-bottom: 8px; 
      font-size: 11px;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    input, select { 
      width: 100%; 
      padding: 14px; 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      background: var(--card-bg);
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box; /* Evita que o padding aumente o tamanho do input */
    }

    input:focus, select:focus { border-color: var(--primary); outline: none; background: #1a221f; }

    /* Correção da Sobreposição na Row */
    .row { 
      display: flex; 
      gap: 15px; 
      width: 100%;
      margin-bottom: 18px;
    }
    .row .form-group { margin-bottom: 0; flex: 1; }

    .btn-salvar { 
      width: 100%; 
      padding: 18px; 
      background: var(--primary); 
      color: var(--deep-bg); 
      border: none; 
      border-radius: 16px; 
      font-weight: 800; 
      font-size: 16px; 
      cursor: pointer; 
      margin-top: 10px;
      transition: 0.3s;
    }

    .btn-salvar:active { transform: scale(0.98); }

    .btn-cancelar { 
      display: block; 
      text-align: center; 
      margin-top: 20px; 
      color: var(--text-muted); 
      text-decoration: none; 
      font-size: 14px; 
      font-weight: 500;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>Editar Anúncio</h2>
  </div>

  <div class="preview-container">
    <img id="imgPreview" src="https://via.placeholder.com/400x220?text=Carregando+Foto...">
  </div>
  
  <div class="form-group">
    <label>Nova Foto (Opcional)</label>
    <input type="file" id="novaImagem" accept="image/*" style="padding: 10px; font-size: 12px;">
  </div>

  <div class="form-group">
    <label>Nome da Ferramenta</label>
    <input type="text" id="nome" placeholder="Ex: Furadeira Bosch">
  </div>

  <div class="row">
    <div class="form-group">
      <label>Preço/Dia</label>
      <input type="number" id="preco" placeholder="00">
    </div>
    <div class="form-group">
      <label>Categoria</label>
      <select id="categoria">
        <option value="Eletricas">Elétricas</option>
        <option value="Jardinagem">Jardinagem</option>
        <option value="Construcao">Construção</option>
        <option value="Pintura">Pintura</option>
      </select>
    </div>
  </div>

  <div class="form-group">
    <label>WhatsApp (com DDD)</label>
    <input type="number" id="whatsapp" placeholder="Ex: 11999999999">
  </div>

  <div class="form-group">
    <label>Bairro / Cidade</label>
    <input type="text" id="cidade" placeholder="Ex: Centro, SP">
  </div>

  <button class="btn-salvar" id="btnSalvar">Salvar Alterações</button>
  <a href="perfil.html" class="btn-cancelar">Descartar mudanças</a>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBLvvoNS4VF2Y0rOh-dHj3GFiwao1D4KYU",
    authDomain: "obrai-56278.firebaseapp.com",
    projectId: "obrai-56278",
    storageBucket: "obrai-56278.firebasestorage.app",
    messagingSenderId: "735990959965",
    appId: "1:735990959965:web:d28f6cbc7b85abfd48e2b4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const anuncioId = params.get("id");
  let fotoAtualBase64 = "";

  async function carregarDados() {
    if (!anuncioId) return;
    try {
      const docSnap = await getDoc(doc(db, "anuncios", anuncioId));
      if (docSnap.exists()) {
        const d = docSnap.data();
        document.getElementById("nome").value = d.nome || "";
        document.getElementById("preco").value = d.preco || "";
        document.getElementById("whatsapp").value = d.whatsapp || "";
        document.getElementById("cidade").value = d.cidade || "";
        document.getElementById("categoria").value = d.categoria || "Eletricas";
        
        if (d.imagem) {
          document.getElementById("imgPreview").src = d.imagem;
          fotoAtualBase64 = d.imagem;
        }
      }
    } catch (e) {
      console.error("Erro ao carregar:", e);
    }
  }

  document.getElementById("novaImagem").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 600;
        const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        fotoAtualBase64 = canvas.toDataURL("image/jpeg", 0.6);
        document.getElementById("imgPreview").src = fotoAtualBase64;
      };
    };
    reader.readAsDataURL(file);
  });

  document.getElementById("btnSalvar").addEventListener("click", async () => {
    const btn = document.getElementById("btnSalvar");
    btn.disabled = true;
    btn.innerText = "Sincronizando...";

    try {
      await updateDoc(doc(db, "anuncios", anuncioId), {
        nome: document.getElementById("nome").value,
        preco: document.getElementById("preco").value,
        whatsapp: String(document.getElementById("whatsapp").value),
        cidade: document.getElementById("cidade").value,
        categoria: document.getElementById("categoria").value,
        imagem: fotoAtualBase64
      });
      window.location.href = "perfil.html";
    } catch (err) {
      alert("Erro ao salvar: " + err.message);
      btn.disabled = false;
      btn.innerText = "Salvar Alterações";
    }
  });

  carregarDados();
</script>
</body>
</html>
